<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="N1CTF 2020 - oflo"><meta name="keywords" content="Binary Security,CTF,Reverse Engineering,Junk Code,Self-Modified Code"><meta name="author" content="一之瀬 千夜"><meta name="copyright" content="一之瀬 千夜"><title>N1CTF 2020 - oflo | 一之瀬 千夜 の Blog</title><link rel="shortcut icon" href="https://s2.loli.net/2023/07/12/DsKYEzGRcNxn3Sm.png"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#N1CTF-2020-oflo"><span class="toc-number">1.</span> <span class="toc-text">N1CTF 2020 - oflo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse"><span class="toc-number">1.1.</span> <span class="toc-text">Reverse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution"><span class="toc-number">1.2.</span> <span class="toc-text">Solution</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">一之瀬 千夜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">8</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.loli.net/2023/06/22/v4DWQBSNg1HFCKc.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">一之瀬 千夜 の Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/links">Links</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">N1CTF 2020 - oflo</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-07-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>матрёшка?</p>
<span id="more"></span>

<h1 id="N1CTF-2020-oflo"><a href="#N1CTF-2020-oflo" class="headerlink" title="N1CTF 2020 - oflo"></a>N1CTF 2020 - oflo</h1><h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><p>When using IDA to analyze the binary file, we can simply found the <code>jmp</code> instruction at <code>0x400BB1</code> has made the disassembler confused.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400B</span>54 ; <span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> **)</span></span><br><span class="line">.text:0000000000400B54 main:                                   ; DATA XREF: start+<span class="number">1</span>D↑o</span><br><span class="line">.text:<span class="number">0000000000400B</span>54                                         ; .text:<span class="number">0000000000400</span>C21↓o</span><br><span class="line">.text:<span class="number">0000000000400B</span>54 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000400B</span>54                 push    rbp</span><br><span class="line">.text:<span class="number">0000000000400B</span>55                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">0000000000400B</span>58                 sub     rsp, <span class="number">240</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>5F                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>68                 mov     [rbp<span class="number">-8</span>], rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>6C                 xor     eax, eax</span><br><span class="line">.text:<span class="number">0000000000400B</span>6E                 lea     rdx, [rbp<span class="number">-210</span>h]</span><br><span class="line">.text:<span class="number">0000000000400B</span>75                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>7A                 mov     ecx, <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>7F                 mov     rdi, rdx</span><br><span class="line">.text:<span class="number">0000000000400B</span>82                 rep stosq</span><br><span class="line">.text:<span class="number">0000000000400B</span>85                 mov     qword ptr [rbp<span class="number">-230</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>90                 mov     qword ptr [rbp<span class="number">-228</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>9B                 mov     qword ptr [rbp<span class="number">-220</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>A6                 mov     qword ptr [rbp<span class="number">-218</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>B1</span><br><span class="line">.text:<span class="number">0000000000400B</span>B1 loc_400BB1:                             ; CODE XREF: .text:loc_400BB1↑j</span><br><span class="line">.text:<span class="number">0000000000400B</span>B1                 jmp     <span class="type">short</span> near ptr loc_400BB1+<span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>B3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>B3                 ror     byte ptr [rax<span class="number">-70</span>h], <span class="number">90</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>B7                 call    loc_400BBF</span><br><span class="line">.text:<span class="number">0000000000400B</span>B7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>BC                 db <span class="number">0E8</span>h, <span class="number">0</span>EBh, <span class="number">12</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>BF ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>As the destination of the <code>jmp</code> is <code>0x400BB1+1</code>, we can just simply patch the byte at <code>0x400BB1</code> to <code>0x90</code> (<code>nop</code>) and restart disassembling.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400B</span>B1                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>B2                 inc     eax</span><br><span class="line">.text:<span class="number">0000000000400B</span>B4                 xchg    rax, rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>B6                 nop</span><br></pre></td></tr></table></figure>

<p>Then it comes to the call to <code>0x400BBF</code>, which is a piece of code gadget that redirecting the control flow by changing the return address on the stack:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400BB7                 call    loc_400BBF</span><br><span class="line">.text:0000000000400BB7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400BBC                 db 0E8h, 0EBh, 12h</span><br><span class="line">.text:0000000000400BBF ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400BBF</span><br><span class="line">.text:0000000000400BBF loc_400BBF:                             ; CODE XREF: .text:0000000000400BB7↑j</span><br><span class="line">.text:0000000000400BBF                 pop     rax             ; ret addr(0x400BBC)</span><br><span class="line">.text:0000000000400BC0                 add     rax, 1          ; rax=0x400BBD</span><br><span class="line">.text:0000000000400BC4                 push    rax             ; push back onto the stack</span><br><span class="line">.text:0000000000400BC5                 mov     rax, rsp        ; following codes are equal to doing nothing</span><br><span class="line">.text:0000000000400BC8                 xchg    rax, [rax]</span><br><span class="line">.text:0000000000400BCB                 pop     rsp</span><br><span class="line">.text:0000000000400BCC                 mov     [rsp], rax</span><br><span class="line">.text:0000000000400BD0                 retn</span><br></pre></td></tr></table></figure>

<p>So we can just patch the <code>call</code> at <code>0x400BB7</code> and the gadget at <code>0x400BBF</code> to <code>nop</code>, then restart disassembling at <code>0x400BBD</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400B</span>BD                 jmp     <span class="type">short</span> loc_400BD1</span><br><span class="line">.text:<span class="number">0000000000400B</span>BF ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>BF                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C0                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C1                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C2                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C3                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C4                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C5                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C6                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C7                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C8                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>C9                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CA                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CB                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CC                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CD                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CE                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>CF                 nop</span><br><span class="line">.text:<span class="number">0000000000400B</span>D0                 nop</span><br></pre></td></tr></table></figure>

<p>As the <code>main()</code> is still undecompilable, let’s just left the <code>sub_4008B9()</code> behind and check for the following code firstly(because reading the raw assembly code really sucks). After some general codes, we get to meet another obfuscated code gadget at <code>0x400CBD</code>, which is almost the same logic as before:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>CAC loc_400CAC:                             ; CODE XREF: .text:<span class="number">0000000000400</span>C47↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>CAC                 cmp     dword ptr [rbp<span class="number">-23</span>Ch], <span class="number">9</span></span><br><span class="line">.text:<span class="number">0000000000400</span>CB3                 jle     <span class="type">short</span> loc_400C49</span><br><span class="line">.text:<span class="number">0000000000400</span>CB5                 call    loc_400CBD</span><br><span class="line">.text:<span class="number">0000000000400</span>CB5 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>CBA                 dw <span class="number">0</span>EBE8h</span><br><span class="line">.text:<span class="number">0000000000400</span>CBC                 db <span class="number">12</span>h</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD loc_400CBD:                             ; CODE XREF: .text:<span class="number">0000000000400</span>CB5↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD                 pop     rax</span><br><span class="line">.text:<span class="number">0000000000400</span>CBE                 add     rax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400</span>CC2                 push    rax</span><br><span class="line">.text:<span class="number">0000000000400</span>CC3                 mov     rax, rsp</span><br><span class="line">.text:<span class="number">0000000000400</span>CC6                 xchg    rax, [rax]</span><br><span class="line">.text:<span class="number">0000000000400</span>CC9                 pop     rsp</span><br><span class="line">.text:<span class="number">0000000000400</span>CCA                 mov     [rsp], rax</span><br><span class="line">.text:<span class="number">0000000000400</span>CCE                 retn</span><br><span class="line">.text:<span class="number">0000000000400</span>CCE ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>CCF                 db <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0000000000400</span>CD0                 dq <span class="number">8348F</span>FFFFDD0858Dh, <span class="number">0F</span>FFDF0958D4805C0h, <span class="number">0E8</span>D78948C68948FFh</span><br></pre></td></tr></table></figure>

<p>So we patch them to <code>nop</code> again and get the correct ones:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>CB5                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CB6                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CB7                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CB8                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CB9                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CBA                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CBB                 jmp     <span class="type">short</span> loc_400CCF</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>CBD                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CBE                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CBF                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC0                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC1                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC2                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC3                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC4                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC5                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC6                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC7                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC8                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CC9                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CCA                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CCB                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CCC                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CCD                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>CCE                 nop</span><br></pre></td></tr></table></figure>

<p>At the <code>loc_400D04</code> there’s another junk code here:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>D04 loc_400D04:                             ; CODE XREF: .text:<span class="number">0000000000400</span>CEE↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>D04                                         ; .text:loc_400D04↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>D04                 jmp     <span class="type">short</span> near ptr loc_400D04+<span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400</span>D04 ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>Just patch the first byte of <code>jmp</code> to <code>nop</code> is okay:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>D04 loc_400D04:                             ; CODE XREF: .text:<span class="number">0000000000400</span>CEE↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>D04                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>D05                 inc     eax</span><br><span class="line">.text:<span class="number">0000000000400</span>D07                 xchg    rax, rax</span><br><span class="line">.text:<span class="number">0000000000400</span>D09                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>D0A                 mov     edi, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400</span>D0F                 call    <span class="built_in">exit</span></span><br><span class="line">.text:<span class="number">0000000000400</span>D14 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>D14                 nop</span><br><span class="line">.text:<span class="number">0000000000400</span>D15                 mov     rax, [rbp<span class="number">-8</span>]</span><br><span class="line">.text:<span class="number">0000000000400</span>D19                 xor     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000400</span>D22                 jz      <span class="type">short</span> locret_400D29</span><br><span class="line">.text:<span class="number">0000000000400</span>D24                 call    ___stack_chk_fail</span><br><span class="line">.text:<span class="number">0000000000400</span>D29 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400</span>D29</span><br><span class="line">.text:<span class="number">0000000000400</span>D29 locret_400D29:                          ; CODE XREF: .text:<span class="number">0000000000400</span>D22↑j</span><br><span class="line">.text:<span class="number">0000000000400</span>D29                 leave</span><br><span class="line">.text:<span class="number">0000000000400</span>D2A                 retn</span><br><span class="line">.text:<span class="number">0000000000400</span>D2A ; &#125; <span class="comment">// starts at 400B54</span></span><br></pre></td></tr></table></figure>

<p>Now press <code>P</code> at the start of <code>main()</code> to left the IDA rethink again, then press <code>F5</code>, here finally comes the discompiled codes for <code>main()</code>:</p>
<ul>
<li>call the <code>sub_4008B9()</code> to do some works</li>
<li>read 19 bytes from input</li>
<li>call <code>mprotect()</code> to mark the first 16 bytes at <code>(unsigned int)main &amp; 0xFFFFC000</code> (which is <code>0x400000</code>) as <code> r | w | x</code></li>
<li>change the first 10 bytes of the <code>sub_400A69()</code></li>
<li>call the <code>sub_400A69()</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// er8</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// er9</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  __int64 v7[<span class="number">4</span>]; <span class="comment">// [rsp+10h] [rbp-230h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">520</span>]; <span class="comment">// [rsp+30h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+238h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v8, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  v7[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v7[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v7[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v7[<span class="number">3</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_4008B9((__int64)v8) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0LL</span>, v7, <span class="number">19LL</span>);</span><br><span class="line">  qword_602048 = (__int64)sub_400A69;</span><br><span class="line">  mprotect((<span class="type">unsigned</span> <span class="type">int</span>)main &amp; <span class="number">0xFFFFC000</span>, <span class="number">16LL</span>, <span class="number">7LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = i % <span class="number">5</span>;</span><br><span class="line">    *(_BYTE *)(qword_602048 + i) ^= *((_BYTE *)v7 + i % <span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_400A69((<span class="type">unsigned</span> <span class="type">int</span>)v8, (<span class="type">unsigned</span> <span class="type">int</span>)v7 + <span class="number">5</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v8, v3, v4, v5) )</span><br><span class="line">    write(<span class="number">1LL</span>, <span class="string">&quot;Cong!\n&quot;</span>, <span class="number">6LL</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now let’s have a look at <code>sub_4008B9()</code>, it uses the sysall <code>fork()</code> to do the whole work. Firstly the children process will wait for the ptracer to attach, then it’ll execute <code>cat /proc/version</code> and exit:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_4008B9</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+14h] [rbp-5Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-54h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+20h] [rbp-50h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+28h] [rbp-48h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-40h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+38h] [rbp-38h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v10[<span class="number">4</span>]; <span class="comment">// [rsp+50h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v10[<span class="number">3</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = fork();</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">    v2 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v10[<span class="number">0</span>] = (__int64)&amp;unk_400DB8;</span><br><span class="line">    v10[<span class="number">1</span>] = (__int64)<span class="string">&quot;/proc/version&quot;</span>;</span><br><span class="line">    v10[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">    v9 = <span class="number">0LL</span>;</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    execve(<span class="string">&quot;/bin/cat&quot;</span>, v10, &amp;v9);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">127LL</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Then let’s take a look at the parent process, it’s mainly a loop that keeps continuously calling the <code>ptrace(PTRACE_PEEKUSER)</code> and <code>ptrace(PTRACE_SYSCALL)</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v5 = a1;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    wait4(v4, &amp;v2, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (v2 &amp; <span class="number">0x7F</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v6 = ptrace(PTRACE_PEEKUSER, v4, <span class="number">120LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="number">1</span>;</span><br><span class="line">        v7 = ptrace(PTRACE_PEEKUSER, v4, <span class="number">104LL</span>, <span class="number">0LL</span>);   <span class="comment">// rsi</span></span><br><span class="line">        v8 = ptrace(PTRACE_PEEKUSER, v4, <span class="number">96LL</span>, <span class="number">0LL</span>);    <span class="comment">// rdx</span></span><br><span class="line">        sub_4007D1(v4, v7, v5, v8);</span><br><span class="line">        v5 += v8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ptrace(PTRACE_SYSCALL, v4, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The offset for different registers is defined in <code>/arch/x86/include/asm/user_64.h</code> as below:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Segment register layout in coredumps.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r15;    <span class="comment">// 0</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r14;    <span class="comment">// 8</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r13;    <span class="comment">// 16</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r12;    <span class="comment">// 24</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bp;     <span class="comment">// 32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bx;     <span class="comment">// 40</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r11;    <span class="comment">// 48</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r10;    <span class="comment">// 56</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r9;     <span class="comment">// 64</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	r8;     <span class="comment">// 72</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ax;     <span class="comment">// 80</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	cx;     <span class="comment">// 88</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	dx;     <span class="comment">// 96</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	si;     <span class="comment">// 104</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	di;     <span class="comment">// 112</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	orig_ax;<span class="comment">// 120</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ip;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	cs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	sp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ss;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	fs_base;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	gs_base;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	ds;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	es;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	fs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	gs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Thus we can get to know what the loop in parent process does: it firstly check whether the value of <code>rax</code> in children process is equal to <code>1</code>, if it does, it’ll read the <code>rsi</code> and <code>rdx</code> in children process and pass them together with a value <code>v5</code> into <code>sub_4007D1()</code>.</p>
<p>The <code>v5</code> is initialized by the first param of <code>sub_4008B9()</code>, which is assigned an offset on the stack:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400B</span>D1 loc_400BD1:                             ; CODE XREF: .text:<span class="number">0000000000400B</span>BD↑j</span><br><span class="line">.text:<span class="number">0000000000400B</span>D1                 lea     rax, [rbp<span class="number">-210</span>h]</span><br><span class="line">.text:<span class="number">0000000000400B</span>D8                 mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>DB                 call    sub_4008B9</span><br></pre></td></tr></table></figure>

<p>Now let’s take a look into <code>sub_4007D1()</code>. What comes first is a loop that keeps reading data from the children process and copy that to the location on the stack that passed as the first param of <code>sub_4008B9()</code>. The source is the space indicated by <code>rsi</code> in children process.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_4007D1</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, __int64 a2, __int64 a3, __int64 a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = a4 / <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v6 &lt; v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(<span class="number">4</span> * v6 + a3) = ptrace(PTRACE_PEEKDATA, a1, a2 + <span class="number">4</span> * v6, <span class="number">0LL</span>);</span><br><span class="line">    ++v6;</span><br><span class="line">  &#125;</span><br><span class="line">  result = a4 % <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(a4 % <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = ptrace(PTRACE_PEEKDATA, a1, a2 + <span class="number">4</span> * v6, <span class="number">0LL</span>);</span><br><span class="line">    *(_QWORD *)(<span class="number">4</span> * v6 + a3) = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>What data it is? As the loop will use <code>prace(PTRACE_SYSCALL)</code> to execute the children process <code>syscall by syscall</code>, and step into the <code>sub_4007D1()</code> only when the <code>orig_rax == 1</code>, we can easily guess out that the parent process is waiting for the syscall who satisfies the <code>nr == 1</code> (as the <code>orig_rax</code> is the syscall number), that is the <code>write()</code>.</p>
<p>Thus we can know that the parent process will copy the data from children process only when it calls the <code>write()</code>, that is, for <code>/bin/cat</code>, the content of <code>/proc/version</code> will be read back to the parent process.</p>
<p>Look back to the <code>main()</code>, as the code at the beginning of <code>sub_400A69()</code> is being changed, we need to change it manually in the IDA. As the source is input and the format of the flag is <code>n1ctf&#123;xxx&#125;</code>, the first 5 bytes are definitely the <code>n1ctf</code>, thus we can just simply fix the <code>sub_400A69()</code> with IDA python:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line">s = <span class="string">&#x27;n1ctf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x400A69</span>, <span class="number">0x400A69</span> + <span class="number">10</span>):</span><br><span class="line">    c = idc.get_db_byte(i)</span><br><span class="line">    c ^= <span class="built_in">ord</span>(s[(i - <span class="number">0x400A69</span>) % <span class="number">5</span>])</span><br><span class="line">    idc.patch_byte(i, c)</span><br></pre></td></tr></table></figure>

<p>Now the begining of <code>sub_400A69()</code> is regular:</p>
<p><img src="https://s2.loli.net/2023/07/14/5nN7fUmPOxT9yRu.png" alt="image.png"></p>
<p>But we still can’t use <code>F5</code> directly because there’re some junk codes below, here we’d just patch the instruction at <code>0x400AC4</code> to <code>nop</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>AC0                 jz      <span class="type">short</span> loc_400AC9</span><br><span class="line">.text:<span class="number">0000000000400</span>AC2                 jnz     <span class="type">short</span> loc_400AC9</span><br><span class="line">.text:<span class="number">0000000000400</span>AC4                 jmp     near ptr <span class="number">801</span>AC9h</span><br><span class="line">.text:<span class="number">0000000000400</span>AC9 ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>Here comes the junk code again, just fix it as what we did before:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400B</span>0E                 call    loc_400B16</span><br><span class="line">.text:<span class="number">0000000000400B</span>0E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>13                 db <span class="number">0E8</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>14                 db <span class="number">0</span>EBh</span><br><span class="line">.text:<span class="number">0000000000400B</span>15                 db  <span class="number">12</span>h</span><br><span class="line">.text:<span class="number">0000000000400B</span>16 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>16</span><br><span class="line">.text:<span class="number">0000000000400B</span>16 loc_400B16:                             ; CODE XREF: sub_400A69+A5↑j</span><br><span class="line">.text:<span class="number">0000000000400B</span>16                 pop     rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>17                 add     rax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400B</span>1B                 push    rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>1C                 mov     rax, rsp</span><br><span class="line">.text:<span class="number">0000000000400B</span>1F                 xchg    rax, [rax]</span><br><span class="line">.text:<span class="number">0000000000400B</span>22                 pop     rsp</span><br><span class="line">.text:<span class="number">0000000000400B</span>23                 mov     [rsp+<span class="number">40</span>h+var_40], rax</span><br><span class="line">.text:<span class="number">0000000000400B</span>27                 retn</span><br><span class="line">.text:<span class="number">0000000000400B</span>27 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000400B</span>28                 db <span class="number">0B</span>8h</span><br></pre></td></tr></table></figure>

<p>Now the <code>sub_400A69()</code> can be discompiled now, which is the core logic of this challenge. The first param is the content of <code>/proc/version</code>, and the second param is our input after <code>nictf</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_400A69</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">24</span>]; <span class="comment">// [rsp+18h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = v2;</span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  qmemcpy(v5, <span class="string">&quot;5-\x11\x1AI&#125;\x11\x14+;&gt;=&lt;_&quot;</span>, <span class="number">14</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">13</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5[i] != ((*(<span class="type">char</span> *)(i + a1) + <span class="number">2</span>) ^ *(<span class="type">char</span> *)(i + a2)) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>As the first 14 bytes of <code>/proc/version</code> is definitely the <code>&quot;Linux version &quot;</code>, we can easily get the flag now:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;5-\x11\x1AI&#125;\x11\x14+;&gt;=&lt;_&quot;</span></span><br><span class="line">b = <span class="string">&quot;Linux version &quot;</span></span><br><span class="line">ans = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">    ans += <span class="built_in">chr</span>(<span class="built_in">ord</span>(s[i]) ^ (<span class="built_in">ord</span>(b[i]) + <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br></pre></td></tr></table></figure>

<p>Here comes the flag:</p>
<p><img src="https://s2.loli.net/2023/07/14/FTlYCB2tacILnD1.png" alt="image.png"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">一之瀬 千夜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ichinose-chiya.github.io/2023/07/14/N1CTF2020-oflo/">https://ichinose-chiya.github.io/2023/07/14/N1CTF2020-oflo/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Binary-Security/">Binary Security</a><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Reverse-Engineering/">Reverse Engineering</a><a class="post-meta__tags" href="/tags/Junk-Code/">Junk Code</a><a class="post-meta__tags" href="/tags/Self-Modified-Code/">Self-Modified Code</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2023/07/13/HNCTF2022_week2_easy-flower/"><span>HNCTF 2022 - WEEK2 - e@sy_flower</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == 'true';
var verify = 'false' == 'true';
var record_ip = 'true' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'rXrIs1NPjZHqnDqpttBOSH8u-gzGzoHsz',
  appKey:'kn1GL4vOKzVwDcl3MIx6V69W',
  placeholder:'Write something here...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://s2.loli.net/2023/06/22/v4DWQBSNg1HFCKc.png)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By 一之瀬 千夜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>